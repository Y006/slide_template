# Makefile for LaTeX documents
FILENAME=main
TEXFILE=$(FILENAME).tex

# ç¼–è¯‘é€‰é¡¹ï¼š1=xelatexä¸¤æ¬¡, 2=å«bibtex, 3=å››æ¬¡xelatex
M ?= 1

.PHONY: main tikz cl h ch

main:
ifeq ($(M),1)
	@xelatex -halt-on-error -interaction=nonstopmode $(TEXFILE)
	@if [ $$? -ne 0 ]; then \
		echo "\033[31mâŒ ç¬¬ä¸€æ¬¡ç¼–è¯‘å¤±è´¥\033[0m"; exit 1; \
	fi
	@xelatex -halt-on-error -interaction=nonstopmode $(TEXFILE)
	@if [ $$? -ne 0 ]; then \
		echo "\033[31mâŒ ç¬¬äºŒæ¬¡ç¼–è¯‘å¤±è´¥\033[0m"; exit 1; \
	fi
	@echo "ğŸ” ç¼–è¯‘æ¨¡å¼ 1ï¼šxelatex -> xelatex"
	@echo "âœ… ç¼–è¯‘å®Œæˆï¼"
endif
ifeq ($(M),2)
	@xelatex -halt-on-error -interaction=nonstopmode $(TEXFILE)
	@if [ $$? -ne 0 ]; then \
		echo "\033[31mâŒ ç¬¬ä¸€æ¬¡ç¼–è¯‘å¤±è´¥\033[0m"; exit 1; \
	fi
	@bibtex $(FILENAME)
	@if [ $$? -ne 0 ]; then \
		echo "\033[31mâŒ bibtex ç¼–è¯‘å¤±è´¥\033[0m"; \
		echo "ğŸ“Œ è¯·ç¡®ä¿ \\bibliography{} å’Œ \\bibliographystyle{} å­˜åœ¨ï¼Œæˆ–ä½¿ç”¨ biber"; \
		exit 1; \
	fi
	@xelatex -halt-on-error -interaction=nonstopmode $(TEXFILE)
	@if [ $$? -ne 0 ]; then \
		echo "\033[31mâŒ ç¬¬äºŒæ¬¡ç¼–è¯‘å¤±è´¥\033[0m"; exit 1; \
	fi
	@xelatex -halt-on-error -interaction=nonstopmode $(TEXFILE)
	@if [ $$? -ne 0 ]; then \
		echo "\033[31mâŒ ç¬¬ä¸‰æ¬¡ç¼–è¯‘å¤±è´¥\033[0m"; exit 1; \
	fi
	@echo "ğŸ” ç¼–è¯‘æ¨¡å¼ 2ï¼šxelatex -> bibtex -> xelatex -> xelatex"
	@echo "âœ… ç¼–è¯‘å®Œæˆï¼"
endif
ifeq ($(M),3)
	@xelatex -halt-on-error -interaction=nonstopmode $(TEXFILE)
	@if [ $$? -ne 0 ]; then \
		echo "\033[31mâŒ ç¬¬ä¸€æ¬¡ç¼–è¯‘å¤±è´¥\033[0m"; exit 1; \
	fi
	@xelatex -halt-on-error -interaction=nonstopmode $(TEXFILE)
	@if [ $$? -ne 0 ]; then \
		echo "\033[31mâŒ ç¬¬äºŒæ¬¡ç¼–è¯‘å¤±è´¥\033[0m"; exit 1; \
	fi
	@xelatex -halt-on-error -interaction=nonstopmode $(TEXFILE)
	@if [ $$? -ne 0 ]; then \
		echo "\033[31mâŒ ç¬¬ä¸‰æ¬¡ç¼–è¯‘å¤±è´¥\033[0m"; exit 1; \
	fi
	@xelatex -halt-on-error -interaction=nonstopmode $(TEXFILE)
	@if [ $$? -ne 0 ]; then \
		echo "\033[31mâŒ ç¬¬å››æ¬¡ç¼–è¯‘å¤±è´¥\033[0m"; exit 1; \
	fi
	@echo "ğŸ” ç¼–è¯‘æ¨¡å¼ 3ï¼šxelatex -> xelatex -> xelatex -> xelatex"
	@echo "âœ… ç¼–è¯‘å®Œæˆï¼"
endif

	@echo "æ˜¯å¦æ¸…ç†ä¸­é—´æ–‡ä»¶ï¼Ÿ(y/n)"
	@read -n 1 clanswer; echo ""; \
	if [ "$$clanswer" = "y" ]; then \
		$(MAKE) cl; \
	else \
		echo "âŒ æœªæ¸…ç†ä¸­é—´æ–‡ä»¶"; \
	fi

	@echo "æ˜¯å¦æ¸…é™¤ç»ˆç«¯è¾“å‡ºï¼Ÿ(y/n)"
	@read -n 1 answer; echo ""; \
	if [ "$$answer" = "y" ]; then \
		clear; \
		echo "âœ… æ¸…é™¤ç»ˆç«¯è¾“å‡ºï¼"; \
	else \
		echo "âŒ æœªæ¸…é™¤ç»ˆç«¯è¾“å‡º"; \
	fi

tikz:
	@if [ -z "$(F)" ]; then \
		echo "âŒ è¯·è¾“å…¥ tikz æ–‡ä»¶è·¯å¾„ï¼šmake tikz F=è·¯å¾„/æ–‡ä»¶åï¼ˆä¸åŠ .texï¼‰"; \
		exit 1; \
	fi
	@echo "ğŸ› ï¸  æ­£åœ¨ç¼–è¯‘ pictures/tikz/$(F).tex ..."
	@xelatex -output-directory=$(dir pictures/tikz/$(F)) pictures/tikz/$(F).tex || \
	( echo "\033[31mâŒ ç¼–è¯‘å¤±è´¥ï¼Œç»ˆæ­¢ Make\033[0m"; exit 1 )
	@rm -f pictures/tikz/$(F).aux pictures/tikz/$(F).log pictures/tikz/$(F).synctex.gz
	@echo "âœ… ç¼–è¯‘å®Œæˆï¼Œå¹¶å·²æ¸…é™¤ä¸­é—´æ–‡ä»¶"
	@echo "æ˜¯å¦æ¸…é™¤ç»ˆç«¯è¾“å‡ºï¼Ÿ(y/n)"
	@read -n 1 answer; \
	if [ "$$answer" = "y" ]; then \
		clear; \
		echo "âœ… æ¸…é™¤å®Œæˆï¼"; \
	else \
		echo "âŒ æœªæ¸…é™¤ç»ˆç«¯è¾“å‡º"; \
	fi

cl:
	@echo "ğŸ§¹ æ­£åœ¨æ¸…ç†ä¸­é—´æ–‡ä»¶..."
	@rm -f $(FILENAME).{aux,bbl,blg,log,nav,out,snm,toc,vrb,synctex.gz,brf}
	@echo "âœ… æ¸…ç†å®Œæˆï¼"

h:
	@echo ""
	@echo "ğŸ“˜ LaTeX Makefile ä½¿ç”¨æŒ‡å—"
	@echo "æœ¬ Makefile æä¾›ä¸€é”®ç¼–è¯‘ã€å‚è€ƒæ–‡çŒ®å¤„ç†ã€TikZ å›¾ç»˜åˆ¶ã€ä¸­é—´æ–‡ä»¶æ¸…ç†ç­‰åŠŸèƒ½ã€‚"
	@echo "ä¸‹è¡¨å±•ç¤ºäº†å¯ç”¨çš„ make å‘½ä»¤åŠå…¶å¯¹åº”åŠŸèƒ½ï¼š"
	@echo ""
	@echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
	@echo "â”‚ å‘½ä»¤                                         â”‚ åŠŸèƒ½                                                   â”‚"
	@echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
	@echo "â”‚ make                                         â”‚ é»˜è®¤ï¼šåŒæ¬¡ xelatex ç¼–è¯‘ï¼Œç¡®ä¿ç›®å½•ã€äº¤å‰å¼•ç”¨æ­£å¸¸ç”Ÿæˆ    â”‚"
	@echo "â”‚ make main                                    â”‚ åŒä¸Š                                                   â”‚"
	@echo "â”‚ make main COMPILE_MODE=2                     â”‚ å¯é€‰ï¼šå« bibtexï¼šç”¨äºå¼•ç”¨æ–‡çŒ®ï¼Œå¸¸ç”¨äºå«å‚è€ƒæ–‡çŒ®çš„è®ºæ–‡  â”‚"
	@echo "â”‚ make main COMPILE_MODE=3                     â”‚ å¯é€‰ï¼šå››æ¬¡ xelatex ç¼–è¯‘ï¼Œç¡®ä¿å…¬å¼æ ‡æ³¨æ­£ç¡®æ˜¾ç¤º		â”‚"
	@echo "â”‚ make tikz FILE=è·¯å¾„/æ–‡ä»¶åï¼ˆä¸åŠ .texï¼‰       â”‚ ç¼–è¯‘å•ä¸ª TikZ å›¾ï¼ˆé»˜è®¤è·¯å¾„ä¸º pictures/tikz/ï¼‰          â”‚"
	@echo "â”‚ make cl                                      â”‚ æ¸…ç†ä¸­é—´æ–‡ä»¶ï¼ˆaux, log, toc ç­‰ï¼‰                       â”‚"
	@echo "â”‚ make ch                                      â”‚ æ£€æŸ¥æ˜¯å¦å®‰è£… xelatex å’Œ bibtex                         â”‚"
	@echo "â”‚ make h                                       â”‚ æ‰“å°æœ¬å¸®åŠ©èœå•                                         â”‚"
	@echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"

ch:
	@echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
	@echo " å·¥å…·                â”‚ çŠ¶æ€                                                                     "
	@echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
	@if command -v xelatex >/dev/null 2>&1; then \
		printf " %-20sâ”‚ å·²å®‰è£…ï¼š%s\n" "xelatex" "$$(xelatex --version | head -n 1)"; \
	else \
		echo " xelatex             â”‚ âŒ æœªæ‰¾åˆ°ï¼Œè¯·å®‰è£… TeX Live æˆ– MacTeX                                     "; \
		exit 1; \
	fi
	@if command -v bibtex >/dev/null 2>&1; then \
		printf " %-20sâ”‚ å·²å®‰è£…ï¼š%s\n" "bibtex" "$$(bibtex --version | head -n 1)"; \
	else \
		echo " bibtex              â”‚ âŒ æœªæ‰¾åˆ°ï¼Œå‚è€ƒæ–‡çŒ®åŠŸèƒ½å°†æ— æ³•ä½¿ç”¨                                          "; \
		exit 1; \
	fi
	@echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

