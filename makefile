TEXFILE = main.tex
FILENAME = main

# ä» main.tex è¯»å–æ ‡è®°
COMPILE_CHAIN := $(shell grep '^% *!compile_chain' $(TEXFILE) | sed 's/.*= *//')
CLEAN_MID := $(shell grep '^% *!clean_midfiles' $(TEXFILE) | sed 's/.*= *//')

# é»˜è®¤ç›®æ ‡
main:
	@echo "ğŸ§  æ£€æµ‹ç¼–è¯‘é“¾: $(COMPILE_CHAIN)"
	@echo "ğŸ§¹ æ˜¯å¦æ¸…ç†ä¸­é—´æ–‡ä»¶: $(CLEAN_MID)"
	@echo "ğŸš€ å¼€å§‹ç¼–è¯‘..."

	@echo "$(COMPILE_CHAIN)" | sed 's/->/\n/g' | while read cmd; do \
		cmd=$$(echo $$cmd | xargs); \
		echo "ğŸ”§ æ‰§è¡ŒæŒ‡ä»¤ï¼š$$cmd"; \
		if [ "$$cmd" = "xelatex" ]; then \
			xelatex -halt-on-error -interaction=nonstopmode $(TEXFILE) >> build.log 2>&1; \
		elif [ "$$cmd" = "bibtex" ]; then \
			bibtex $(FILENAME) >> build.log 2>&1; \
		elif [ "$$cmd" = "biber" ]; then \
			biber $(FILENAME) >> build.log 2>&1; \
		else \
			echo "\033[33mâš ï¸ æœªçŸ¥å‘½ä»¤ï¼š$$cmd\033[0m"; \
		fi; \
		if [ $$? -ne 0 ]; then \
			echo "\033[31mâŒ ç¼–è¯‘é˜¶æ®µ $$cmd å¤±è´¥\033[0m"; \
			echo "ğŸ” è¯·æ£€æŸ¥ build.log è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"; \
			exit 1; \
		fi; \
	done

	@echo "âœ… ç¼–è¯‘å®Œæˆï¼"

	@if [ "$(CLEAN_MID)" = "true" ]; then \
		$(MAKE) cl; \
	fi

cl:
	@echo "ğŸ§¹ æ­£åœ¨æ¸…ç†ä¸­é—´æ–‡ä»¶..."
	@rm -f $(FILENAME).{aux,bbl,blg,log,nav,out,snm,toc,vrb,synctex.gz,brf}
	@echo "âœ… æ¸…ç†å®Œæˆï¼"

h:
	@echo ""
	@echo "ğŸ“˜ LaTeX Makefile ä½¿ç”¨æŒ‡å—"
	@echo ""
	@echo "æœ¬ Makefile æ”¯æŒé€šè¿‡åœ¨ main.tex æ–‡ä»¶ä¸­æ·»åŠ æ³¨é‡Šæ¥æ§åˆ¶ç¼–è¯‘æµç¨‹ã€‚"
	@echo ""
	@echo "ğŸ› ï¸ æ ‡è®°è§„åˆ™ï¼ˆå†™åœ¨ main.tex é¡¶éƒ¨ï¼‰ï¼š"
	@echo "   % !compile_chain = xelatex -> bibtex -> xelatex -> xelatex"
	@echo "   % !clean_midfiles = true"
	@echo ""
	@echo "ğŸ“Œ compile_chainï¼š"
	@echo "   - è®¾ç½®ç¼–è¯‘é¡ºåºï¼Œå¯åŒ…å« xelatexã€bibtexã€biber"
	@echo "   - å¤šæ¬¡ xelatex ç”¨äºå¤„ç†äº¤å‰å¼•ç”¨ã€ç›®å½•ã€annotated equations"
	@echo ""
	@echo "ğŸ“Œ clean_midfilesï¼š"
	@echo "   - è‹¥ä¸º trueï¼Œç¼–è¯‘å®Œæˆåè‡ªåŠ¨åˆ é™¤ä¸­é—´æ–‡ä»¶ï¼ˆaux, log ç­‰ï¼‰"
	@echo ""
	@echo "ğŸ“¦ å¸¸ç”¨å‘½ä»¤è¯´æ˜ï¼š"
	@echo ""
	@echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
	@echo "â”‚ å‘½ä»¤                   â”‚ åŠŸèƒ½                                       â”‚"
	@echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
	@echo "â”‚ make                   â”‚ é»˜è®¤ç¼–è¯‘ï¼Œè‡ªåŠ¨è¯»å– main.tex ä¸­çš„ç¼–è¯‘é“¾     â”‚"
	@echo "â”‚ make main              â”‚ ä¸ make ç›¸åŒï¼Œæ‰§è¡Œè‡ªå®šä¹‰ç¼–è¯‘é“¾             â”‚"
	@echo "â”‚ make cl                â”‚ æ¸…ç†ä¸­é—´æ–‡ä»¶ï¼ˆaux, log, toc ç­‰ï¼‰           â”‚"
	@echo "â”‚ make ch                â”‚ æ£€æŸ¥æ˜¯å¦å®‰è£… xelatex å’Œ bibtex å·¥å…·        â”‚"
	@echo "â”‚ make h                 â”‚ æ‰“å°æœ¬å¸®åŠ©èœå•                             â”‚"
	@echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
	@echo ""
	@echo "ğŸ“‚ ç¼–è¯‘æ—¥å¿—å·²é‡å®šå‘è‡³ build.logï¼Œå¦‚å¤±è´¥è¯·ä½¿ç”¨ï¼š"
	@echo "   tail -n 50 build.log"
	@echo ""
	@echo "ğŸ“„ æ›´å¤šæ–‡æ¡£è¯´æ˜è¯·è§ README.md æˆ– main.tex é¡¶éƒ¨æ³¨é‡ŠåŒº"

ch:
	@echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
	@echo " å·¥å…·                â”‚ çŠ¶æ€                                                                     "
	@echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
	@if command -v xelatex >/dev/null 2>&1; then \
		printf " %-20sâ”‚ å·²å®‰è£…ï¼š%s\n" "xelatex" "$$(xelatex --version | head -n 1)"; \
	else \
		echo " xelatex             â”‚ âŒ æœªæ‰¾åˆ°ï¼Œè¯·å®‰è£… TeX Live æˆ– MacTeX                                     "; \
		exit 1; \
	fi
	@if command -v bibtex >/dev/null 2>&1; then \
		printf " %-20sâ”‚ å·²å®‰è£…ï¼š%s\n" "bibtex" "$$(bibtex --version | head -n 1)"; \
	else \
		echo " bibtex              â”‚ âŒ æœªæ‰¾åˆ°ï¼Œå‚è€ƒæ–‡çŒ®åŠŸèƒ½å°†æ— æ³•ä½¿ç”¨                                          "; \
		exit 1; \
	fi
	@echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

